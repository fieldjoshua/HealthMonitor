<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Updated on last push: Force GitHub Pages update -->
  <title>Modern Dark Health Monitoring Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Add Google Fonts for a modern look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js for doughnut graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Modern design system with Inter font, updated color palette */
    :root {
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --color-text: #f1f5f9;
      --color-text-muted: #94a3b8;
      --color-primary: #0ea5e9;
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-danger: #ef4444;
      --color-info: #3b82f6;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.3);
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--color-text);
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      letter-spacing: -0.01em;
    }
    
    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 2rem;
    }
    
    /* Dashboard Container */
    #dashboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
    }
    
    .card {
      background: var(--bg-card);
      width: 160px;
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .card:hover { 
      transform: translateY(-4px); 
      box-shadow: var(--shadow-lg);
      background: #1e293b; 
    }
    
    .card .icon { 
      font-size: 28px; 
      margin-bottom: 12px;
      opacity: 0.9;
    }
    
    .chart-container {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto 8px;
    }
    
    .chart-container canvas {
      width: 80px !important;
      height: 80px !important;
      display: block;
    }
    
    .chart-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      font-weight: 600;
      z-index: 10;
      pointer-events: none;
    }
    
    .label {
      margin-top: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text);
    }
    
    /* Connection Status Bar */
    #connectionStatusBar {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      text-align: center;
      border-radius: var(--radius-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #3b82f6;
      box-shadow: var(--shadow-sm);
    }
    
    #toggleSyncMode {
      background: rgba(0,0,0,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    
    #toggleSyncMode:hover {
      background: rgba(0,0,0,0.3);
    }
    
    /* Progress Bar Card */
    .progress-card {
      width: 100%;
      margin-bottom: 16px;
      background: var(--bg-card);
      padding: 16px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .progress-card .title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .progress-card .subtitle {
      font-size: 13px;
      color: var(--color-text-muted);
      margin-bottom: 12px;
    }
    
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 12px;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
      background: var(--color-primary);
    }
    
    /* Section styling */
    .section {
      display: none;
      margin-top: 20px;
      background: var(--bg-card);
      padding: 24px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .section.active { display: block; }
    
    .btn-back {
      background: rgba(239, 68, 68, 0.9);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: 500;
      transition: background 0.2s ease;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-back:hover {
      background: rgba(220, 38, 38, 1);
    }
    
    /* Table and input styling for reporting sections */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    
    th, td {
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      text-align: center;
      vertical-align: middle;
    }
    
    th { 
      background: rgba(255,255,255,0.05);
      font-weight: 600;
    }
    
    .timestamp {
      display: block;
      font-size: 0.8em;
      color: var(--color-text-muted);
      margin-top: 5px;
    }
    
    select, input[type="text"], input[type="time"], input[type="number"], textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      box-sizing: border-box;
      font-size: 14px;
      background: rgba(255,255,255,0.05);
      color: var(--color-text);
      font-family: 'Inter', system-ui, sans-serif;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      background: rgba(255,255,255,0.08);
    }
    
    .input-group { margin-bottom: 20px; }
    
    .input-group label { 
      display: block; 
      font-weight: 500; 
      margin-bottom: 8px;
      color: var(--color-text);
    }
    
    button.save-btn {
      background: var(--color-primary);
      border: none;
      border-radius: var(--radius-sm);
      padding: 12px 20px;
      cursor: pointer;
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow-sm);
      transition: background 0.2s ease, transform 0.1s ease;
      font-family: 'Inter', system-ui, sans-serif;
    }
    
    button.save-btn:hover { 
      background: #0284c7; 
    }
    
    button.save-btn:active {
      transform: translateY(1px);
    }
    
    /* Info cards */
    .info-card {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-size: 14px;
      border-left: 3px solid var(--color-info);
    }
    
    /* Responsive settings for smartphones */
    @media (max-width: 600px) {
      body { padding: 12px; }
      h1 { font-size: 1.5rem; }
      .card { width: 140px; padding: 12px; }
      .chart-container { width: 70px; height: 70px; }
      .chart-label { font-size: 14px; }
      .label { font-size: 12px; }
      .section { padding: 16px; }
    }
  </style>
</head>
<body>
  <h1>Health Monitoring Dashboard</h1>
  <!-- MAIN DASHBOARD -->
  <div id="dashboard">
    <!-- Connection Status will be inserted here by JS -->
    <div id="connectionStatusBar">
      <span>⏳ Connecting to Google Sheets...</span>
      <button id="toggleSyncMode">
        Use Local Storage
      </button>
    </div>
    
    <!-- Total Progress Card -->
    <div class="progress-card">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div class="title">Total Progress</div>
          <div class="subtitle">Daily health accomplishments</div>
        </div>
        <div id="totalProgressDisplay" style="font-size:24px;font-weight:600;color:var(--color-primary);">0%</div>
      </div>
      <div class="progress-bar-container">
        <div id="totalProgressBar" class="progress-bar" style="width:0%;"></div>
      </div>
    </div>
    <!-- Medication Card -->
    <div class="card" onclick="openSection('medSection')">
      <div class="icon"><i class="fas fa-pills" style="color:#e74c3c;"></i></div>
      <div class="chart-container">
        <canvas id="medChart"></canvas>
        <div class="chart-label" id="medChartLabel"><i class="fas fa-check-circle"></i></div>
      </div>
      <div class="label">Medications</div>
    </div>
    <!-- Weight Card -->
    <div class="card" onclick="openSection('weightSection')">
      <div class="icon"><i class="fas fa-weight" style="color:#1abc9c;"></i></div>
      <div class="chart-container">
        <canvas id="weightChart"></canvas>
        <div class="chart-label" id="weightChartLabel">-</div>
      </div>
      <div class="label">Weight</div>
    </div>
    <!-- Bowel Movements Card -->
    <div class="card" onclick="openSection('bmSection')">
      <div class="icon"><i class="fas fa-poo" style="color:#27ae60;"></i></div>
      <div class="chart-container">
        <canvas id="bmChart"></canvas>
        <div class="chart-label" id="bmChartLabel">0/3</div>
      </div>
      <div class="label">Bowel Movements</div>
    </div>
    <!-- Drink Intake Card -->
    <div class="card" onclick="openSection('drinkSection')">
      <div class="icon"><i class="fas fa-tint" style="color:#3498db;"></i></div>
      <div class="chart-container">
        <canvas id="drinkChart"></canvas>
        <div class="chart-label" id="drinkChartLabel">0/8</div>
      </div>
      <div class="label">Drink Intake</div>
    </div>
    <!-- Meals & Nutrition Card -->
    <div class="card" onclick="openSection('mealsSection')">
      <div class="icon"><i class="fas fa-utensils" style="color:#f1c40f;"></i></div>
      <div class="chart-container">
        <canvas id="mealsChart"></canvas>
        <div class="chart-label" id="mealsChartLabel">0/5</div>
      </div>
      <div class="label">Meals</div>
    </div>
    <!-- Sleep Card -->
    <div class="card" onclick="openSection('sleepSection')">
      <div class="icon"><i class="fas fa-bed" style="color:#8e44ad;"></i></div>
      <div class="chart-container">
        <canvas id="sleepChart"></canvas>
        <div class="chart-label" id="sleepChartLabel">0h</div>
      </div>
      <div class="label">Sleep</div>
    </div>
    <!-- Activity Card -->
    <div class="card" onclick="openSection('activitySection')">
      <div class="icon"><i class="fas fa-running" style="color:#e67e22;"></i></div>
      <div class="chart-container">
        <canvas id="activityChart"></canvas>
        <div class="chart-label" id="activityChartLabel">0m</div>
      </div>
      <div class="label">Activity</div>
    </div>
    <!-- Mental/Physical Tests Card -->
    <div class="card" onclick="openSection('mentalSection')">
      <div class="icon"><i class="fas fa-brain" style="color:#2ecc71;"></i></div>
      <div class="chart-container">
        <canvas id="mentalChart"></canvas>
        <div class="chart-label" id="mentalChartLabel">0/2</div>
      </div>
      <div class="label">Mental/Physical</div>
    </div>
    <!-- Physical Symptoms Card -->
    <div class="card" onclick="openSection('symptomSection')">
      <div class="icon"><i class="fas fa-stethoscope" style="color:#f39c12;"></i></div>
      <div class="chart-container">
        <canvas id="symptomChart"></canvas>
        <div class="chart-label" id="symptomChartLabel">0/1</div>
      </div>
      <div class="label">Symptoms</div>
    </div>
    <!-- Notes Card -->
    <div class="card" onclick="openSection('notesSection')">
      <div class="icon"><i class="fas fa-sticky-note" style="color:#34495e;"></i></div>
      <div class="chart-container">
        <canvas id="notesChart"></canvas>
        <div class="chart-label" id="notesChartLabel"><i class="fas fa-comment"></i></div>
      </div>
      <div class="label">Notes</div>
    </div>
  </div>

  <!-- SECTION: Medications -->
  <div id="medSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Today's Medications</h2>
    <table>
      <thead>
        <tr>
          <th>Medication</th>
          <th>Morning<br>(6-9 AM)</th>
          <th>Noon<br>(11-1 PM)</th>
          <th>Evening<br>(5-8 PM)</th>
          <th>Bedtime<br>(9-11 PM)</th>
        </tr>
      </thead>
      <tbody id="medTableBody">
        <!-- Rows generated dynamically -->
      </tbody>
    </table>
    <button class="save-btn" onclick="saveSection('medications')">Done</button>
  </div>

  <!-- SECTION: Weight -->
  <div id="weightSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Daily Weight Tracking</h2>
    <div class="info-card">
      For best results, weigh yourself in the morning after using the bathroom and before eating or drinking.
    </div>
    <div class="input-group">
      <label>Today's Weight:</label>
      <input type="number" id="weightInput" step="0.1" min="50" max="500" placeholder="Enter weight (lbs)">
    </div>
    <div class="input-group">
      <label>Notes (optional):</label>
      <select id="weightNotes">
        <option value="">Select or leave blank</option>
        <option>Morning weight</option>
        <option>Evening weight</option>
        <option>After exercise</option>
        <option>After eating</option>
        <option>Before eating</option>
        <option>Feeling bloated</option>
        <option>Feeling dehydrated</option>
        <option>Different scale used</option>
        <option>Clothing on</option>
      </select>
    </div>
    <button class="save-btn" onclick="saveSection('weight')">Submit</button>
  </div>

  <!-- SECTION: Bowel Movements -->
  <div id="bmSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Bowel Movement Reporting</h2>
    <div class="info-card">
      Target: 2–3 soft stools per day (Lactulose dose should be adjusted to achieve this)
    </div>
    <div class="input-group">
      <label>I had a stool that was:</label>
      <select id="bmSelect">
        <option value="">Select type</option>
        <option>Hard</option>
        <option>Normal</option>
        <option>Soft</option>
        <option>Watery</option>
      </select>
    </div>
    <div class="input-group">
      <label>Stool color:</label>
      <select id="bmColor">
        <option value="">Select color</option>
        <option>Brown (normal)</option>
        <option>Pale/Clay colored</option>
        <option>Dark/Black</option>
        <option>Bloody/Red</option>
      </select>
    </div>
    <div class="input-group">
      <label>Additional notes:</label>
      <select id="bmNotes">
        <option value="">Select or leave blank</option>
        <option>Difficult to pass</option>
        <option>Easy to pass</option>
        <option>Urgent/sudden</option>
        <option>Multiple BMs today</option>
        <option>First BM in 2+ days</option>
        <option>After taking medication</option>
        <option>After eating</option>
        <option>With cramping</option>
        <option>With gas</option>
        <option>With bloating</option>
      </select>
    </div>
    <button class="save-btn" onclick="saveSection('bowelMovements')">Submit</button>
  </div>

  <!-- SECTION: Drink Intake -->
  <div id="drinkSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Drink Intake Reporting</h2>
    <div class="info-card">
      Target: 1.5–2 liters of water daily (about 6-8 cups)
    </div>
    <div class="input-group">
      <label>I drank:</label>
      <select id="drinkAmount">
        <option value="">Select amount</option>
        <option>1 cup</option>
        <option>2 cups</option>
        <option>3 cups</option>
        <option>4 cups</option>
      </select>
    </div>
    <div class="input-group">
      <label>of:</label>
      <select id="drinkType">
        <option value="">Select type</option>
        <option>Water</option>
        <option>Juice</option>
        <option>Electrolytes</option>
        <option>Other</option>
      </select>
    </div>
    <button class="save-btn" onclick="saveSection('drinkIntake')">Submit</button>
  </div>

  <!-- SECTION: Meals & Nutrition -->
  <div id="mealsSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Meals & Nutrition Reporting</h2>
    <div class="info-card">
      Protein Goal: 1.0–1.5 g/kg/day (include in every meal)<br>
      Salt Restriction: Less than 2 grams/day
    </div>
    <div class="input-group">
      <label>I ate:</label>
      <select id="mealDetails">
        <option value="">Select meal</option>
        <option>Toast/bread</option>
        <option>Cereal</option>
        <option>Eggs</option>
        <option>Yogurt</option>
        <option>Fruit</option>
        <option>Vegetables</option>
        <option>Salad</option>
        <option>Soup</option>
        <option>Sandwich</option>
        <option>Chicken</option>
        <option>Fish</option>
        <option>Beef/red meat</option>
        <option>Rice/pasta</option>
        <option>Protein shake</option>
        <option>Protein bar</option>
        <option>Nuts/seeds</option>
        <option>Cheese</option>
        <option>Milk/dairy</option>
        <option>Mixed meal (balanced)</option>
      </select>
    </div>
    <div class="input-group">
      <label>Protein Amount:</label>
      <select id="proteinAmount">
        <option value="">Select amount</option>
        <option>0g (None)</option>
        <option>5g (Very low)</option>
        <option>10g (Low)</option>
        <option>15g (Moderate)</option>
        <option>20g (Good)</option>
        <option>25g (High)</option>
        <option>30g+ (Very high)</option>
      </select>
    </div>
    <div class="input-group">
      <label>Salt Intake:</label>
      <select id="saltIntake">
        <option value="">Select level</option>
        <option>No added salt</option>
        <option>Low sodium</option>
        <option>Moderate sodium</option>
        <option>High sodium</option>
      </select>
      </div>
      <div class="input-group">
      <label>Appetite:</label>
      <select id="appetite">
        <option value="">Select</option>
        <option>Poor</option>
        <option>Fair</option>
        <option>Good</option>
      </select>
    </div>
    <button class="save-btn" onclick="saveSection('meals')">Submit</button>
  </div>

  <!-- SECTION: Sleep -->
  <div id="sleepSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Sleep Reporting</h2>
    <div class="input-group">
      <label>I slept (hours):</label>
      <select id="sleepHours">
        <option value="">Select hours</option>
        <option>Less than 4</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option>10</option>
        <option>More than 10</option>
      </select>
    </div>
    <div class="input-group">
      <label>Sleep Quality:</label>
      <select id="sleepQuality">
        <option value="">Select quality</option>
        <option>Poor</option>
        <option>Fair</option>
        <option>Good</option>
      </select>
    </div>
    <button class="save-btn" onclick="saveSection('sleep')">Submit</button>
  </div>

  <!-- SECTION: Activity -->
  <div id="activitySection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Activity Reporting</h2>
    <div class="input-group">
      <label>I was active for (minutes):</label>
      <select id="activityMinutes">
        <option value="">Select duration</option>
        <option>5</option>
        <option>10</option>
        <option>15</option>
        <option>20</option>
        <option>25</option>
        <option>30</option>
        <option>45</option>
        <option>60 (1 hour)</option>
        <option>90 (1.5 hours)</option>
        <option>120+ (2+ hours)</option>
      </select>
    </div>
    <div class="input-group">
      <label>Activity Type:</label>
      <select id="activityType">
        <option value="">Select activity</option>
        <option>Walking</option>
        <option>Light stretching</option>
        <option>Housework</option>
        <option>Gardening</option>
        <option>Standing activities</option>
        <option>Seated exercises</option>
        <option>Gentle yoga</option>
        <option>Physical therapy exercises</option>
        <option>Other light activity</option>
      </select>
    </div>
    <button class="save-btn" onclick="saveSection('activity')">Submit</button>
  </div>

  <!-- SECTION: Mental/Physical Tests -->
  <div id="mentalSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Mental &amp; Physical Tests</h2>
    <div class="info-card">
      Complete at least 2 tests below to mark this section as complete.
    </div>
    <div class="input-group">
      <label>Alert &amp; Oriented?</label><br>
      <input type="radio" name="alertStatus" value="Yes"> Yes
      <input type="radio" name="alertStatus" value="No"> No
    </div>
    <div class="input-group">
      <label>Hand Tremor Test:</label><br>
      <input type="checkbox" name="tremor" value="no_tremor"> No tremor visible<br>
      <input type="checkbox" name="tremor" value="slight_tremor"> Slight tremor at rest<br>
      <input type="checkbox" name="tremor" value="arm_tremor"> Tremor when arms extended<br>
      <input type="checkbox" name="tremor" value="asterixis"> Flapping (asterixis)<br>
      <input type="checkbox" name="tremor" value="severe"> Unable to hold arms steady for 10 seconds
    </div>
    <div class="input-group">
      <label>Memory Test:</label><br>
      <input type="checkbox" name="memory" value="knows_date"> Knows today's date<br>
      <input type="checkbox" name="memory" value="knows_location"> Knows where they are<br>
      <input type="checkbox" name="memory" value="recall"> Can recall what they had for breakfast<br>
      <input type="checkbox" name="memory" value="name_objects"> Can name 3 objects shown<br>
      <input type="checkbox" name="memory" value="repeat_words"> Can repeat 3 words after 5 minutes<br>
      <input type="checkbox" name="memory" value="follow_steps"> Can follow a 2-step instruction<br>
      <input type="checkbox" name="memory" value="draw_clock"> Can draw a clock showing a specific time
    </div>
    <div class="input-group">
      <label>Additional Neurological Signs:</label><br>
      <input type="checkbox" name="neuro" value="slow_speech"> Slowed speech<br>
      <input type="checkbox" name="neuro" value="irritability"> Irritability<br>
      <input type="checkbox" name="neuro" value="reversed_sleep"> Reversed sleep-wake cycle<br>
      <input type="checkbox" name="neuro" value="coordination"> Difficulty with coordination
    </div>
    <button class="save-btn" onclick="saveSection('mental')">Submit</button>
  </div>

  <!-- SECTION: Physical Symptoms -->
  <div id="symptomSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Physical Symptoms Reporting</h2>
    <div class="input-group">
      <label>Symptom:</label>
      <select id="symptomSelect">
        <option value="">Select symptom</option>
        <option>Itching</option>
        <option>Nausea</option>
        <option>Abdominal pain</option>
        <option>Swelling (legs/abdomen)</option>
        <option>Yellowing of skin/eyes</option>
        <option>Fatigue</option>
        <option>Loss of appetite</option>
        <option>Dark urine</option>
        <option>Confusion or disorientation</option>
        <option>Bleeding/bruising easily</option>
      </select>
    </div>
    <div class="input-group">
      <label>Severity:</label>
      <select id="severitySelect">
        <option value="">Select severity</option>
        <option>None</option>
        <option>Mild</option>
        <option>Moderate</option>
        <option>Severe</option>
      </select>
    </div>
    <div class="input-group">
      <label>Notes (optional):</label>
      <select id="symptomNotes">
        <option value="">Select or leave blank</option>
        <option>Morning only</option>
        <option>Afternoon only</option>
        <option>Evening only</option>
        <option>All day</option>
        <option>After meals</option>
        <option>Before meals</option>
        <option>During activity</option>
        <option>At rest</option>
        <option>Interferes with sleep</option>
        <option>Improves with medication</option>
        <option>No change with medication</option>
        <option>Worse than yesterday</option>
        <option>Better than yesterday</option>
        <option>Same as yesterday</option>
      </select>
    </div>
    <button class="save-btn" onclick="recordSymptom()">Record</button>
    <!-- Display recorded symptoms -->
    <h3>Today's Symptoms</h3>
    <ul id="symptomList" style="list-style:none;padding:0;margin:0;"></ul>
    <button class="save-btn" onclick="saveSection('symptoms')">Submit</button>
  </div>

  <!-- SECTION: Notes -->
  <div id="notesSection" class="section">
    <button class="btn-back" onclick="closeSection()">← Back to Dashboard</button>
    <h2>Notes &amp; Additional Comments</h2>
    <div class="input-group">
      <textarea id="notesText" placeholder="Enter any observations, concerns, or questions..."></textarea>
    </div>
    <button class="save-btn" onclick="saveSection('notes')">Submit</button>
  </div>

  <script>
    /* -------------------------
       Chart.js Verification
       ------------------------- */
    // Check if Chart.js is loaded properly
    function checkChartJsLoaded() {
      if (typeof Chart === 'undefined') {
        console.error("Chart.js is not loaded! Adding fallback...");
        // Add a fallback loading of Chart.js if the CDN failed
        const scriptTag = document.createElement('script');
        scriptTag.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js';
        scriptTag.onload = function() {
          console.log("Chart.js fallback loaded successfully");
          // Reinitialize charts once loaded
          if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(initCharts, 100);
          }
        };
        document.head.appendChild(scriptTag);
        return false;
      }
      console.log("Chart.js is loaded properly");
      return true;
    }
    
    /* -------------------------
       Daily Persistence & Midnight Refresh
       ------------------------- */
    const todayKey = new Date().toISOString().slice(0,10);

  // Check if we need to archive yesterday's data and reset for today
  function checkDayChange() {
    const savedDate = localStorage.getItem('savedDate');
    const currentDate = new Date().toISOString().slice(0, 10);

    if (savedDate && savedDate !== currentDate) {
      console.log(`Day changed from ${savedDate} to ${currentDate}. Archiving data...`);

      // Archive yesterday's data
      archiveData(savedDate);

      // Clear current data
      resetDailyData();

      // Set the new date
      localStorage.setItem('savedDate', currentDate);
    } else if (!savedDate) {
      // First time visit, just set the date
      localStorage.setItem('savedDate', currentDate);
    }
  }

  // Create archive of the day's data
  function archiveData(dateString) {
    try {
      // Create the archive structure if it doesn't exist
      const archiveData = JSON.parse(localStorage.getItem('healthArchive') || '{}');

      // Save each data category
      const dailyArchive = {
        medications: JSON.parse(localStorage.getItem('medicationRecords') || '[]'),
        weight: JSON.parse(localStorage.getItem('weightRecord') || '{}'),
        bowelMovement: JSON.parse(localStorage.getItem('bmRecord') || '{}'),
        drinkIntake: JSON.parse(localStorage.getItem('drinkRecord') || '{}'),
        meals: JSON.parse(localStorage.getItem('mealsRecord') || '{}'),
        protein: PROTEIN_GOAL,
        saltRestriction: SALT_GOAL,
        sleep: JSON.parse(localStorage.getItem('sleepRecord') || '{}'),
        activity: JSON.parse(localStorage.getItem('activityRecord') || '{}'),
        mental: JSON.parse(localStorage.getItem('mentalRecord') || '{}'),
        symptoms: JSON.parse(localStorage.getItem('physicalSymptoms') || '[]'),
        notes: localStorage.getItem('notesRecord') || ''
      };

      // Add this day's data to the archive
      archiveData[dateString] = dailyArchive;

      // Save the updated archive back to localStorage
      localStorage.setItem('healthArchive', JSON.stringify(archiveData));

      // Optional: Try to sync this archived data to Google Sheets if enabled
      if (!CONFIG.localModeOnly && CONFIG.enableGoogleSheets) {
        postDataToSheet('daily_archive', {
          date: dateString,
          data: dailyArchive
        }).catch(err => {
          console.error('Failed to sync archived data to Google Sheets:', err);
        });
      }

      console.log(`Successfully archived data for ${dateString}`);
    } catch (error) {
      console.error('Error archiving data:', error);
    }
  }

  // Reset all daily tracking data
  function resetDailyData() {
    // Clear all the daily records but keep the archive and settings
    const keysToKeep = ['healthArchive', 'savedDate'];

    // Save config settings temporarily
    const savedConfig = {
      localModeOnly: CONFIG.localModeOnly,
      googleSheetsApiUrl: CONFIG.googleSheetsApiUrl
    };

    // Get all keys in localStorage
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && !keysToKeep.includes(key)) {
        localStorage.removeItem(key);
      }
    }

    // Restore settings
    if (savedConfig.googleSheetsApiUrl) {
      CONFIG.googleSheetsApiUrl = savedConfig.googleSheetsApiUrl;
      CONFIG.localModeOnly = savedConfig.localModeOnly;
    }

    // Reset all the runtime variables
    medicationRecords = [];
    weightRecord = {};
    bmRecord = {};
    drinkRecord = {};
    mealsRecord = {};
    sleepRecord = {};
    activityRecord = {};
    mentalRecord = {};
    physicalSymptoms = [];
    notesRecord = "";

    console.log('Daily data has been reset');
    }

  // Run the check when the page loads
  checkDayChange();

  // Schedule the midnight refresh
    function scheduleMidnightRefresh() {
      const now = new Date();
      const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      const timeToMidnight = midnight - now;

      console.log(`Scheduling midnight refresh in ${Math.round(timeToMidnight / 1000 / 60)} minutes`);

      setTimeout(() => {
        // Archive today's data with today's date
        archiveData(todayKey);

        // Reset the data for the new day
        resetDailyData();

        // Update the saved date
        localStorage.setItem('savedDate', new Date().toISOString().slice(0, 10));

        // Reload the page to refresh everything
        location.reload();
      }, timeToMidnight + 1000); // Add 1 second buffer after midnight
    }

    scheduleMidnightRefresh();

    /* -------------------------
       Daily Goals (from discharge and tracking standards)
       ------------------------- */
                      const BM_GOAL = 3;  // Goal is 2-3 soft stools per day per Lactulose instructions
                      const DRINK_GOAL = 8;  // Changed to represent 1.5-2 liters (about 8 cups)
                      const MEALS_GOAL = 3;  // Three main meals per day
                      const PROTEIN_GOAL = true;  // Need to track protein intake at 1.0-1.5 g/kg/day
                      const SALT_GOAL = true;  // Need to track low sodium diet (<2g/day)
                      const SLEEP_GOAL = 8;  // Standard sleep goal
                      const ACTIVITY_GOAL = 20; // Daily light activity goal

    /* -------------------------
       Data Structures & Persistence
       ------------------------- */
    // Medication schedule (reversed relative to reference):
    // Lactulose and Hydroxyzine originally had administered in hospital so now they show dash (flag true).
    const medications = [
      { name: "Lactulose (30 mL)", schedule: { Morning: false, Noon: false, Evening: false, Bedtime: false } },
      { name: "Rifaximin (550 mg)", schedule: { Morning: true, Noon: false, Evening: true, Bedtime: false } },
      { name: "Ursodiol (300 mg x2)", schedule: { Morning: true, Noon: false, Evening: true, Bedtime: false } },
      { name: "Ferrous Gluconate (324 mg)", schedule: { Morning: true, Noon: false, Evening: false, Bedtime: false } },
      { name: "Levothyroxine (25 mcg)", schedule: { Morning: true, Noon: false, Evening: false, Bedtime: false } },
      { name: "Losartan (50 mg)", schedule: { Morning: true, Noon: false, Evening: false, Bedtime: false } },
      { name: "Cholestyramine (4g)", schedule: { Morning: true, Noon: false, Evening: true, Bedtime: false } },
      { name: "Hydroxyzine (25 mg as needed)", schedule: { Morning: false, Noon: false, Evening: false, Bedtime: false } },
      { name: "Calcium (1200 mg)", schedule: { Morning: true, Noon: false, Evening: false, Bedtime: false } },
      { name: "Vitamin D (≥1000 IU)", schedule: { Morning: true, Noon: false, Evening: false, Bedtime: false } }
    ];
    let medicationRecords = JSON.parse(localStorage.getItem('medicationRecords')) || [];
    
                            // New weight record
                            let weightRecord = JSON.parse(localStorage.getItem('weightRecord')) || {};
                          
    // Handle bowel movement record - could be string or object based on app version
    let bmRecord = {};
    try {
      const storedBmRecord = localStorage.getItem('bmRecord');
      if (storedBmRecord) {
        // Try to parse as JSON first
        try {
          bmRecord = JSON.parse(storedBmRecord);
        } catch (e) {
          // If parsing fails, it's an old string format - convert to new format
          console.log("Converting old bmRecord format to new format");
          bmRecord = {
            type: storedBmRecord, 
            color: "Brown (normal)",
            notes: "",
            timestamp: new Date().toLocaleTimeString()
          };
          // Save in new format
          localStorage.setItem('bmRecord', JSON.stringify(bmRecord));
        }
      }
    } catch (e) {
      console.error("Error handling bmRecord:", e);
      bmRecord = {};
    }
    
    let drinkRecord = JSON.parse(localStorage.getItem('drinkRecord')) || {};
    let mealsRecord = JSON.parse(localStorage.getItem('mealsRecord')) || {};
    let sleepRecord = JSON.parse(localStorage.getItem('sleepRecord')) || {};
    let activityRecord = JSON.parse(localStorage.getItem('activityRecord')) || {};
    let mentalRecord = JSON.parse(localStorage.getItem('mentalRecord')) || {};
    let physicalSymptoms = JSON.parse(localStorage.getItem('physicalSymptoms')) || [];
    let notesRecord = localStorage.getItem('notesRecord') || "";

    /* -------------------------
       Generate Medication Table
       ------------------------- */
    function generateMedTable() {
      const tbody = document.getElementById('medTableBody');
      tbody.innerHTML = '';
      medications.forEach(med => {
        let tr = document.createElement('tr');
        let nameTd = document.createElement('td');
        nameTd.textContent = med.name;
        tr.appendChild(nameTd);
        ["Morning", "Noon", "Evening", "Bedtime"].forEach(slot => {
          let td = document.createElement('td');
          // If schedule flag is false -> show checkbox; if true -> show dash.
          if (!med.schedule[slot]) {
            let cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.setAttribute('data-med', med.name);
            cb.setAttribute('data-slot', slot);
            cb.setAttribute('data-time', getScheduledHour(slot));
            cb.onchange = recordMedCheck;
            const existing = medicationRecords.find(r => r.medName === med.name && r.timeSlot === slot);
            if (existing) { cb.checked = true; }
            td.appendChild(cb);
            let span = document.createElement('span');
            span.className = 'timestamp';
            if (existing) { span.textContent = existing.timestamp; }
            td.appendChild(span);
          } else {
            td.textContent = "—";
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
    function getScheduledHour(slot) {
      switch(slot) {
        case "Morning": return 6;
        case "Noon": return 11;
        case "Evening": return 17;
        case "Bedtime": return 21;
        default: return 0;
      }
    }

    /* -------------------------
       Medication Logic
       ------------------------- */
    function recordMedCheck(event) {
      try {
        // Get the checkbox from the event
        const checkbox = event ? event.target : this;
        
        if (!checkbox || typeof checkbox.getAttribute !== 'function') {
          console.error("Invalid checkbox element:", checkbox);
          return;
        }
        
        const scheduledHour = parseInt(checkbox.getAttribute('data-time'), 10);
        const nowHour = new Date().getHours();
        if (nowHour < scheduledHour) {
          checkbox.checked = false;
          return;
        }
        const tsSpan = checkbox.parentElement.querySelector('.timestamp');
        if (checkbox.checked) {
          const timestamp = new Date().toLocaleTimeString();
          tsSpan.textContent = timestamp;
          medicationRecords.push({
            medName: checkbox.getAttribute('data-med'),
            timeSlot: checkbox.getAttribute('data-slot'),
            timestamp
          });
        } else {
          tsSpan.textContent = "";
          medicationRecords = medicationRecords.filter(r =>
            !(r.medName === checkbox.getAttribute('data-med') && r.timeSlot === checkbox.getAttribute('data-slot'))
          );
        }
        localStorage.setItem('medicationRecords', JSON.stringify(medicationRecords));
      } catch (error) {
        console.error("Error in recordMedCheck:", error);
      }
    }

    /* -------------------------
       Physical Symptom Reporting
       ------------------------- */
    function recordSymptom() {
      const symptom = document.getElementById('symptomSelect').value;
      const severity = document.getElementById('severitySelect').value;
      const notes = document.getElementById('symptomNotes').value;
      if (!symptom || !severity) return;  // must select symptom and severity
      const timestamp = new Date().toLocaleTimeString();
      physicalSymptoms.push({ symptom, severity, notes, timestamp });
      localStorage.setItem('physicalSymptoms', JSON.stringify(physicalSymptoms));
      renderSymptoms();
      // Reset fields
      document.getElementById('symptomSelect').selectedIndex = 0;
      document.getElementById('severitySelect').selectedIndex = 0;
      document.getElementById('symptomNotes').value = "";
    }
    function renderSymptoms() {
      const list = document.getElementById('symptomList');
      list.innerHTML = "";
      physicalSymptoms.forEach((item, index) => {
        let li = document.createElement('li');
        li.style.marginBottom = "5px";
        li.style.padding = "5px";
        li.style.border = "1px solid #333";
        li.style.borderRadius = "4px";
        li.innerHTML = `<strong>${item.symptom}</strong> (${item.severity}) @ ${item.timestamp} <em>${item.notes}</em> <button style="background:none;border:none;color:#e74c3c;cursor:pointer;" onclick="removeSymptom(${index})">&times;</button>`;
        list.appendChild(li);
      });
    }
    function removeSymptom(idx) {
      physicalSymptoms.splice(idx, 1);
      localStorage.setItem('physicalSymptoms', JSON.stringify(physicalSymptoms));
      renderSymptoms();
    }

    /* -------------------------
       Chart Initialization & Update
       ------------------------- */
                        let medChart, bmChart, drinkChart, mealsChart, sleepChart, activityChart, mentalChart, notesChart, symptomChart, weightChart;
    function initCharts() {
      medChart = createChart(document.getElementById('medChart').getContext('2d'), '#e74c3c');
      weightChart = createChart(document.getElementById('weightChart').getContext('2d'), '#1abc9c');
      bmChart = createChart(document.getElementById('bmChart').getContext('2d'), '#27ae60');
      drinkChart = createChart(document.getElementById('drinkChart').getContext('2d'), '#3498db');
      mealsChart = createChart(document.getElementById('mealsChart').getContext('2d'), '#f1c40f');
      sleepChart = createChart(document.getElementById('sleepChart').getContext('2d'), '#8e44ad');
      activityChart = createChart(document.getElementById('activityChart').getContext('2d'), '#e67e22');
      mentalChart = createChart(document.getElementById('mentalChart').getContext('2d'), '#2ecc71');
      notesChart = createChart(document.getElementById('notesChart').getContext('2d'), '#34495e');
      symptomChart = createChart(document.getElementById('symptomChart').getContext('2d'), '#f39c12');
      updateCharts();
    }
    function createChart(ctx, color) {
      try {
        if (!ctx) {
          console.error("Canvas context is null or undefined for color:", color);
          return null;
        }
        return new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [0, 100],
              backgroundColor: [color, '#555'],
              borderWidth: 0
            }]
          },
          options: {
            cutout: '70%',
            responsive: false,
            plugins: { tooltip: { enabled: false }, legend: { display: false } }
          }
        });
      } catch (error) {
        console.error("Error creating chart with color " + color + ":", error);
        return null;
      }
    }
    function updateCharts() {
      // Medications: percentage = (# doses taken) / (total scheduled doses) * 100
      const medGoal = medications.reduce((acc, med) => {
        for (let slot in med.schedule) { if (!med.schedule[slot]) acc++; }
        return acc;
      }, 0);
      const medPerc = medGoal ? Math.round((medicationRecords.length / medGoal) * 100) : 0;
      updateChartData(medChart, medPerc);
      document.getElementById('medChartLabel').innerHTML = `<i class="fas fa-pills"></i><br>${medPerc}%`;
      
      // Weight: binary goal (recorded or not)
      const weightPerc = weightRecord.weight ? 100 : 0;
      updateChartData(weightChart, weightPerc);
      document.getElementById('weightChartLabel').textContent = weightRecord.weight ? `${weightRecord.weight}` : "-";
      
      // Bowel Movements: target = BM_GOAL
      const bmCount = typeof bmRecord === 'object' && bmRecord.type ? 1 : 0;
      const bmPerc = bmCount ? Math.round((bmCount / BM_GOAL) * 100) : 0;
      updateChartData(bmChart, bmPerc);
      document.getElementById('bmChartLabel').textContent = bmCount ? `1/${BM_GOAL}` : `0/${BM_GOAL}`;
      
      // Drink Intake: target = DRINK_GOAL cups
      const drinkPerc = drinkRecord.amount ? Math.round((1 / DRINK_GOAL) * 100) : 0;
      updateChartData(drinkChart, drinkPerc);
      document.getElementById('drinkChartLabel').textContent = drinkRecord.amount ? `1/${DRINK_GOAL}` : `0/${DRINK_GOAL}`;
      
      // Meals: target = MEALS_GOAL meals
      const mealsPerc = mealsRecord.details ? Math.round((1 / MEALS_GOAL) * 100) : 0;
      updateChartData(mealsChart, mealsPerc);
      document.getElementById('mealsChartLabel').textContent = mealsRecord.details ? `1/${MEALS_GOAL}` : `0/${MEALS_GOAL}`;
      
      // Sleep: percentage = (hours / SLEEP_GOAL)*100, cap at 100
      const sleepVal = sleepRecord.hours || 0;
      const sleepPerc = Math.min(Math.round((sleepVal / SLEEP_GOAL) * 100), 100);
      updateChartData(sleepChart, sleepPerc);
      document.getElementById('sleepChartLabel').textContent = sleepVal ? `${sleepVal}h` : "0h";
      
      // Activity: percentage = (minutes / ACTIVITY_GOAL)*100, cap at 100
      const actVal = activityRecord.minutes || 0;
      const actPerc = Math.min(Math.round((actVal / ACTIVITY_GOAL) * 100), 100);
      updateChartData(activityChart, actPerc);
      document.getElementById('activityChartLabel').textContent = actVal ? `${actVal}m` : "0m";
      
      // Mental/Physical: binary goal (now requires at least 2 test parts)
      let mentalTestsCompleted = 0;

      // Count alertStatus test
      if (mentalRecord.alertStatus) mentalTestsCompleted++;

      // Count tremor test (if any checkbox is checked)
      if (mentalRecord.tremor && mentalRecord.tremor.length > 0) mentalTestsCompleted++;

      // Count memory test (if any checkbox is checked)
      if (mentalRecord.memory && mentalRecord.memory.length > 0) mentalTestsCompleted++;

      // Count neuro test (if any checkbox is checked)
      if (mentalRecord.neuro && mentalRecord.neuro.length > 0) mentalTestsCompleted++;

      // Mark as complete if at least 2 tests were done
      const mentalPerc = mentalTestsCompleted >= 2 ? 100 : 0;
      updateChartData(mentalChart, mentalPerc);
      document.getElementById('mentalChartLabel').textContent = mentalPerc === 100 ? "2/2" : `${mentalTestsCompleted}/2`;
      
      // Physical Symptoms: binary goal (at least one symptom reported)
      const symptomPerc = physicalSymptoms.length > 0 ? 100 : 0;
      updateChartData(symptomChart, symptomPerc);
      document.getElementById('symptomChartLabel').textContent = physicalSymptoms.length > 0 ? "1/1" : "0/1";
      
      // Notes: binary goal
      const notesPerc = notesRecord ? 100 : 0;
      updateChartData(notesChart, notesPerc);
      document.getElementById('notesChartLabel').innerHTML = notesRecord ? `<i class="fas fa-comment"></i>` : `<i class="fas fa-comment-slash"></i>`;

      // Calculate total progress percentage
      // Weight each category based on importance and calculate overall percentage
      const categories = [
        { name: "Medications", percentage: medPerc, weight: 25 },
        { name: "Weight", percentage: weightPerc, weight: 5 },
        { name: "Bowel Movements", percentage: bmPerc, weight: 15 },
        { name: "Drink Intake", percentage: drinkPerc, weight: 10 },
        { name: "Meals", percentage: mealsPerc, weight: 15 },
        { name: "Sleep", percentage: sleepPerc, weight: 10 },
        { name: "Activity", percentage: actPerc, weight: 10 },
        { name: "Mental Tests", percentage: mentalPerc, weight: 5 },
        { name: "Symptoms", percentage: symptomPerc, weight: 5 }
      ];

      let totalWeightedPercentage = 0;
      let totalWeight = 0;

      categories.forEach(category => {
        totalWeightedPercentage += category.percentage * category.weight;
        totalWeight += category.weight;
      });

      const totalProgress = Math.round(totalWeightedPercentage / totalWeight);

      // Update total progress display
      document.getElementById('totalProgressDisplay').textContent = `${totalProgress}%`;
      document.getElementById('totalProgressBar').style.width = `${totalProgress}%`;

      // Set progress bar color based on percentage
      const progressBar = document.getElementById('totalProgressBar');
      if (totalProgress < 30) {
        progressBar.style.background = '#e74c3c'; // Red
      } else if (totalProgress < 70) {
        progressBar.style.background = '#f39c12'; // Orange
      } else {
        progressBar.style.background = '#2ecc71'; // Green
      }
    }
    function updateChartData(chart, value) {
      if (!chart) {
        console.warn("Attempted to update null chart");
        return;
      }
      try {
        chart.data.datasets[0].data = [value, 100 - value];
        chart.update();
      } catch (error) {
        console.error("Error updating chart:", error);
      }
    }

    /* -------------------------
       Navigation Functions
       ------------------------- */
    function openSection(sectionId) {
      document.getElementById('dashboard').style.display = 'none';
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      if (sectionId === 'medSection') { generateMedTable(); }
      if (sectionId === 'symptomSection') { renderSymptoms(); }
    }
    function closeSection() {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById('dashboard').style.display = 'flex';
      updateCharts();
    }

    /* -------------------------
       Configuration
       ------------------------- */
    const CONFIG = {
      googleSheetsApiUrl: "https://script.google.com/macros/s/AKfycby3aigOPxwySAt46XdYUyienta8oM6ZQVsM2qEi79nd9M2kOvr5mmi9F6R8d0SDSVUX/exec",
      enableGoogleSheets: true,
      localModeOnly: false, // Changed to false - now Google Sheets is the default
      debugMode: true
    };

    /* -------------------------
       Sync Mode Toggle
       ------------------------- */
    function toggleSyncMode() {
      CONFIG.localModeOnly = !CONFIG.localModeOnly;
      
      const statusBar = document.getElementById('connectionStatusBar');
      const toggleBtn = document.getElementById('toggleSyncMode');
      
      if (CONFIG.localModeOnly) {
        // Switch to local mode
        statusBar.style.background = '#e67e22';
        statusBar.querySelector('span').innerHTML = '📱 Using Local Storage Mode';
        toggleBtn.textContent = 'Enable Google Sheets';
        console.log("Switched to local storage only mode");
      } else {
        // Try to use Google Sheets
        statusBar.style.background = '#3498db';
        statusBar.querySelector('span').innerHTML = '⏳ Testing Google Sheets Connection...';
        toggleBtn.textContent = 'Use Local Storage';
        
        // Test the connection
        testGoogleSheetsConnection().then(result => {
          if (result.result === "error" || result.result === "local_only") {
            // If connection failed, switch back to local mode
            CONFIG.localModeOnly = true;
            statusBar.style.background = '#e74c3c';
            statusBar.querySelector('span').innerHTML = '❌ Google Sheets Connection Failed';
            toggleBtn.textContent = 'Try Again';
            console.warn("Google Sheets connection failed. Using local mode.");
          } else {
            // Connection successful
            statusBar.style.background = '#27ae60';
            statusBar.querySelector('span').innerHTML = '☁️ Using Google Sheets Sync';
            console.log("Google Sheets connection successful");
          }
        });
      }
    }

    /* -------------------------
       Test Connection
       ------------------------- */
    async function testGoogleSheetsConnection() {
      // Reference to the status bar that's already in the DOM
      const statusBar = document.getElementById('connectionStatusBar');
      const statusSpan = statusBar.querySelector('span');
      const toggleBtn = document.getElementById('toggleSyncMode');

      if (CONFIG.localModeOnly) {
        console.log("Skipping connection test - using local mode only");
        return { result: "local_only" };
      }
      
      try {
        console.log("Testing Google Sheets connection...");
        console.log("Using URL:", CONFIG.googleSheetsApiUrl);
        
        const testData = {
          section: "test",
          payload: { test: "connection" }
        };
        
        // First try a GET request which typically has fewer CORS issues
        try {
          const getResponse = await fetch(CONFIG.googleSheetsApiUrl);
          console.log("Response status:", getResponse.status);
          
          if (getResponse.ok) {
            const result = await getResponse.json();
            console.log("Test response:", result);
            
            // Update status in existing UI
            statusBar.style.background = '#27ae60';
            statusSpan.innerHTML = '✓ Google Sheets Connected (GET works)';
            
            // Now try the POST request using the form approach
            const postResult = await new Promise((resolve) => {
              // Create a unique ID for this request
              const requestId = 'req_test_' + Date.now();
              
              // Create a form to submit the data
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = CONFIG.googleSheetsApiUrl;
              form.target = 'hidden_iframe_test_' + requestId;
              form.style.display = 'none';
              
              // Add the data as a hidden input
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'data';
              input.value = JSON.stringify(testData);
              form.appendChild(input);
              
              // Create a hidden iframe to receive the response
              const iframe = document.createElement('iframe');
              iframe.name = 'hidden_iframe_test_' + requestId;
              iframe.id = 'hidden_iframe_test_' + requestId;
              iframe.style.display = 'none';
              
              // Add elements to the DOM
              document.body.appendChild(iframe);
              document.body.appendChild(form);
              
              // Set a timeout to handle no response
              const timeoutId = setTimeout(() => {
                try {
                  document.body.removeChild(form);
                  document.body.removeChild(iframe);
                } catch (e) {}
                
                // Update status
                statusSpan.innerHTML = '✓ Google Sheets Connected (POST likely working)';
                
                resolve({ result: "success", message: "POST likely working" });
              }, 5000);
              
              // Try to listen for iframe load
              iframe.onload = () => {
                clearTimeout(timeoutId);
                try {
                  document.body.removeChild(form);
                  document.body.removeChild(iframe);
                } catch (e) {}
                
                // Update status
                statusSpan.innerHTML = '✓ Google Sheets Connected';
                
                resolve({ result: "success", message: "POST confirmed working" });
              };
              
              // Submit the form
              form.submit();
            });
            
            return postResult;
          } else {
            throw new Error(`GET request failed with status: ${getResponse.status}`);
          }
        } catch (getError) {
          console.error("GET request failed:", getError);
          
          // Check if this is a CORS error
          const isCorsError = String(getError).includes('CORS') || 
                             String(getError).includes('cross-origin') || 
                             String(getError).includes('blocked by policy');
          
          if (isCorsError) {
            CONFIG.localModeOnly = true;
            
            // Update status to indicate local mode due to CORS
            statusBar.style.background = '#e67e22';
            statusSpan.innerHTML = '⚠ CORS Error: Using Local Storage Only Mode';
            toggleBtn.textContent = 'Try Again';
              
            return { result: "local_only", error: "CORS issues detected" };
          }
          
          // Fall back to direct form-based POST test
          statusBar.style.background = '#e67e22';
          statusSpan.innerHTML = '⚠ GET Failed, Trying POST Method...';
          
          // Try POST via form
          const postResult = await new Promise((resolve) => {
            // Create a unique ID for this request
            const requestId = 'req_test_' + Date.now();
            
            // Create a form to submit the data
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = CONFIG.googleSheetsApiUrl;
            form.target = 'hidden_iframe_test_' + requestId;
            form.style.display = 'none';
            
            // Add the data as a hidden input
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(testData);
            form.appendChild(input);
            
            // Create a hidden iframe to receive the response
            const iframe = document.createElement('iframe');
            iframe.name = 'hidden_iframe_test_' + requestId;
            iframe.id = 'hidden_iframe_test_' + requestId;
            iframe.style.display = 'none';
            
            // Add elements to the DOM
            document.body.appendChild(iframe);
            document.body.appendChild(form);
            
            // Set a timeout to handle no response
            const timeoutId = setTimeout(() => {
              try {
                document.body.removeChild(form);
                document.body.removeChild(iframe);
              } catch (e) {}
              
              // Update status
              statusBar.style.background = '#e67e22';
              statusSpan.innerHTML = '⚠ GET Failed, POST May Work';
              
              resolve({ result: "success", message: "POST likely working" });
            }, 5000);
            
            // Try to listen for iframe load
            iframe.onload = () => {
              clearTimeout(timeoutId);
              try {
                document.body.removeChild(form);
                document.body.removeChild(iframe);
              } catch (e) {}
              
              // Update status
              statusBar.style.background = '#27ae60';
              statusSpan.innerHTML = '✓ POST Connection Successful';
              
              resolve({ result: "success", message: "POST confirmed working" });
            };
            
            // Submit the form
            form.submit();
          });
          
          return postResult;
        }
      } catch (error) {
        console.error("Connection test failed:", error);
        
        // Update status to show failure
        statusBar.style.background = '#e74c3c';
        statusSpan.innerHTML = '✗ Connection Failed: Using Local Storage Only';
        CONFIG.localModeOnly = true;
        
        return { result: "error", error: error.toString() };
      }
    }

    /* -------------------------
       Google Sheets Integration
       ------------------------- */
    async function postDataToSheet(sectionName, payload) {
      // Reference to status elements
      const statusBar = document.getElementById('connectionStatusBar');
      const statusSpan = statusBar.querySelector('span');
      
      if (!CONFIG.enableGoogleSheets || CONFIG.localModeOnly) {
        if (CONFIG.localModeOnly) {
          console.log(`Using local storage only mode: ${sectionName} data saved locally`);
        } else {
          console.log("Google Sheets integration is disabled");
        }
        return { result: "local_only" };
      }

      try {
        const data = {
          section: sectionName,
          payload: payload
        };
        
        if (CONFIG.debugMode) {
          console.log("Posting data to Google Sheets:", sectionName);
        }
        
        // Briefly indicate syncing
        const originalText = statusSpan.innerHTML;
        statusSpan.innerHTML = `⏳ Syncing ${sectionName}...`;
        
        // Create and submit the form in an iframe
        const result = await new Promise((resolve, reject) => {
          // Create a unique ID for this request
          const requestId = 'req_' + Date.now();
          
          // Create a form to submit the data
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = CONFIG.googleSheetsApiUrl;
          form.target = 'hidden_iframe_' + requestId;
          form.style.display = 'none';
          
          // Add the data as a hidden input
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'data';
          input.value = JSON.stringify(data);
          form.appendChild(input);
          
          // Create a hidden iframe to receive the response
          const iframe = document.createElement('iframe');
          iframe.name = 'hidden_iframe_' + requestId;
          iframe.id = 'hidden_iframe_' + requestId;
          iframe.style.display = 'none';
          
          // Add elements to the DOM
          document.body.appendChild(iframe);
          document.body.appendChild(form);
          
          // Handle completion
          const cleanupAndResolve = (status, message) => {
            // Clean up DOM elements
            try {
              document.body.removeChild(form);
              document.body.removeChild(iframe);
            } catch (e) {
              console.warn('Cleanup error:', e);
            }
            
            resolve({
              result: status,
              message: message
            });
          };
          
          // Set a timeout to handle no response
          const timeoutId = setTimeout(() => {
            cleanupAndResolve('success', 'Request completed (presumed successful)');
          }, 5000);
          
          // Try to listen for iframe load
          iframe.onload = () => {
            clearTimeout(timeoutId);
            // We assume success since the form was submitted
            console.log("Form submission to Google Sheets completed");
            cleanupAndResolve('success', 'Data saved to Google Sheets');
          };
          
          // Submit the form
          try {
            form.submit();
            console.log("Form submitted to Google Sheets");
          } catch (submitError) {
            clearTimeout(timeoutId);
            cleanupAndResolve('error', 'Form submission error: ' + submitError.message);
          }
        });
        
        // Restore original status after successful sync
        if (result.result === "success") {
          statusSpan.innerHTML = originalText;
        }
        
        return result;
      } catch (error) {
        console.error("Error posting data to Google Sheet:", error);
        
        // Check if this might be a CORS error
        if (error.message && (
            error.message.includes('CORS') || 
            error.message.includes('blocked by policy') ||
            error.message.includes('cross-origin')
        )) {
          CONFIG.localModeOnly = true;
          console.warn("CORS error detected. Switching to local storage only mode.");
          
          // Update UI to show local mode
          statusBar.style.background = '#e67e22';
          statusSpan.innerHTML = '⚠ Using Local Storage Only - CORS Issue';
          document.getElementById('toggleSyncMode').textContent = 'Try Google Sheets';
        }
        
        return { result: "error", error: error.toString() };
      }
    }

    /* -------------------------
       Save Section Data (Auto-Save & Return)
       ------------------------- */
    async function saveSection(sectionName) {
      let payload = {};
      
      try {
        switch(sectionName) {
          case 'medications':
            payload = { records: medicationRecords };
            localStorage.setItem('medicationRecords', JSON.stringify(medicationRecords));
            break;
          case 'weight':
            const weightValue = document.getElementById('weightInput').value;
            if (!weightValue || isNaN(parseFloat(weightValue))) {
              alert("Please enter a valid weight");
              return;
            }

            weightRecord = {
              weight: parseFloat(weightValue).toFixed(1),
              notes: document.getElementById('weightNotes').value,
              timestamp: new Date().toLocaleTimeString()
            };
            payload = weightRecord;
            localStorage.setItem('weightRecord', JSON.stringify(weightRecord));
            break;
          case 'bowelMovements':
            bmRecord = {
              type: document.getElementById('bmSelect').value,
              color: document.getElementById('bmColor').value,
              notes: document.getElementById('bmNotes').value,
              timestamp: new Date().toLocaleTimeString()
            };
            payload = bmRecord;
            localStorage.setItem('bmRecord', JSON.stringify(bmRecord));
            break;
          case 'drinkIntake':
            drinkRecord.amount = document.getElementById('drinkAmount').value;
            drinkRecord.type = document.getElementById('drinkType').value;
            payload = drinkRecord;
            localStorage.setItem('drinkRecord', JSON.stringify(drinkRecord));
            break;
          case 'meals':
            mealsRecord.details = document.getElementById('mealDetails').value;
            mealsRecord.protein = document.getElementById('proteinAmount').value;
            mealsRecord.salt = document.getElementById('saltIntake').value;
            mealsRecord.appetite = document.getElementById('appetite').value;
            payload = mealsRecord;
            localStorage.setItem('mealsRecord', JSON.stringify(mealsRecord));
            break;
          case 'sleep':
            sleepRecord.hours = document.getElementById('sleepHours').value;
            sleepRecord.quality = document.getElementById('sleepQuality').value;
            payload = sleepRecord;
            localStorage.setItem('sleepRecord', JSON.stringify(sleepRecord));
            break;
          case 'activity':
            activityRecord.minutes = document.getElementById('activityMinutes').value;
            activityRecord.type = document.getElementById('activityType').value;
            payload = activityRecord;
            localStorage.setItem('activityRecord', JSON.stringify(activityRecord));
            break;
          case 'mental':
            mentalRecord.alertStatus = document.querySelector('input[name="alertStatus"]:checked')?.value || "";
            
            // Add tremor assessment
            mentalRecord.tremor = Array.from(document.querySelectorAll('input[name="tremor"]:checked'))
              .map(input => input.value);
              
            // Add memory assessment
            mentalRecord.memory = Array.from(document.querySelectorAll('input[name="memory"]:checked'))
              .map(input => input.value);
              
            // Add neurological signs
            mentalRecord.neuro = Array.from(document.querySelectorAll('input[name="neuro"]:checked'))
              .map(input => input.value);
              
            payload = mentalRecord;
            localStorage.setItem('mentalRecord', JSON.stringify(mentalRecord));
            break;
          case 'notes':
            notesRecord = document.getElementById('notesText').value;
            payload = { notes: notesRecord };
            localStorage.setItem('notesRecord', notesRecord);
            break;
          case 'symptoms':
            payload = { symptoms: physicalSymptoms };
            localStorage.setItem('physicalSymptoms', JSON.stringify(physicalSymptoms));
            break;
          default:
            break;
        }

        // Post data to Google Sheets
        const result = await postDataToSheet(sectionName, payload);
        if (result.result === "success") {
          console.log(`Successfully saved ${sectionName} data to Google Sheets`);
        }
      } catch (error) {
        console.error(`Error saving ${sectionName} data:`, error);
      } finally {
        closeSection();
      }
    }

    /* -------------------------
       Connection Diagnostics
       ------------------------- */
    async function runDiagnostics() {
      const diagnosticsDiv = document.createElement('div');
      diagnosticsDiv.style.position = 'fixed';
      diagnosticsDiv.style.top = '10px';
      diagnosticsDiv.style.right = '10px';
      diagnosticsDiv.style.backgroundColor = '#1e1e1e';
      diagnosticsDiv.style.border = '1px solid #555';
      diagnosticsDiv.style.borderRadius = '8px';
      diagnosticsDiv.style.padding = '15px';
      diagnosticsDiv.style.width = '350px';
      diagnosticsDiv.style.maxHeight = '80vh';
      diagnosticsDiv.style.overflowY = 'auto';
      diagnosticsDiv.style.zIndex = '1000';
      diagnosticsDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.5)';
      diagnosticsDiv.innerHTML = `
        <h3 style="margin-top:0;border-bottom:1px solid #555;padding-bottom:5px;">Connection Diagnostics</h3>
        <div id="diagnosticsResults" style="font-family:monospace;font-size:12px;"></div>
        <div style="margin-top:10px;display:flex;gap:5px;">
          <button id="closeDiagnostics" style="flex:1;background:#e74c3c;border:none;padding:5px;border-radius:4px;color:white;cursor:pointer;">Close</button>
          <button id="testHttpbin" style="flex:1;background:#3498db;border:none;padding:5px;border-radius:4px;color:white;cursor:pointer;">Test Httpbin</button>
          <button id="testAppScript" style="flex:1;background:#2ecc71;border:none;padding:5px;border-radius:4px;color:white;cursor:pointer;">Test Apps Script</button>
        </div>
        <div style="margin-top:10px;">
          <input id="customEndpoint" type="text" placeholder="Enter custom endpoint to test" style="width:100%;padding:5px;box-sizing:border-box;background:#2c2c2c;border:1px solid #555;color:#e0e0e0;border-radius:4px;">
          <button id="testCustom" style="width:100%;margin-top:5px;background:#9b59b6;border:none;padding:5px;border-radius:4px;color:white;cursor:pointer;">Test Custom Endpoint</button>
        </div>
      `;
      
      document.body.appendChild(diagnosticsDiv);
      
      const resultsDiv = document.getElementById('diagnosticsResults');
      
      document.getElementById('closeDiagnostics').addEventListener('click', () => {
        document.body.removeChild(diagnosticsDiv);
      });
      
      document.getElementById('testHttpbin').addEventListener('click', async () => {
        resultsDiv.innerHTML += `<div style="margin:5px 0;border-bottom:1px dashed #555;padding-bottom:5px;">Testing httpbin.org POST...</div>`;
        try {
          const response = await fetch('https://httpbin.org/post', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({test: 'connection'})
          });
          
          const data = await response.json();
          resultsDiv.innerHTML += `<div style="color:#2ecc71;">✓ Httpbin test successful!</div>`;
          resultsDiv.innerHTML += `<div style="max-height:100px;overflow:auto;background:#2c2c2c;padding:5px;margin:5px 0;border-radius:4px;">${JSON.stringify(data, null, 2)}</div>`;
        } catch (error) {
          resultsDiv.innerHTML += `<div style="color:#e74c3c;">✗ Httpbin test failed: ${error.message}</div>`;
        }
      });
      
      document.getElementById('testAppScript').addEventListener('click', async () => {
        resultsDiv.innerHTML += `<div style="margin:5px 0;border-bottom:1px dashed #555;padding-bottom:5px;">Testing Google Apps Script URL...</div>`;
        
        // First test with GET request
        try {
          resultsDiv.innerHTML += `<div>Testing GET request...</div>`;
          const getResponse = await fetch(CONFIG.googleSheetsApiUrl);
          const getStatus = getResponse.status;
          resultsDiv.innerHTML += `<div>GET Status: ${getStatus}</div>`;
          
          try {
            const getData = await getResponse.json();
            resultsDiv.innerHTML += `<div style="color:#2ecc71;">✓ GET response parsed as JSON</div>`;
            resultsDiv.innerHTML += `<div style="max-height:100px;overflow:auto;background:#2c2c2c;padding:5px;margin:5px 0;border-radius:4px;">${JSON.stringify(getData, null, 2)}</div>`;
          } catch (e) {
            const getText = await getResponse.text();
            resultsDiv.innerHTML += `<div style="color:#e74c3c;">✗ GET response is not valid JSON</div>`;
            resultsDiv.innerHTML += `<div style="max-height:100px;overflow:auto;background:#2c2c2c;padding:5px;margin:5px 0;border-radius:4px;white-space:pre-wrap;font-size:10px;">${getText.substring(0, 500)}${getText.length > 500 ? '...' : ''}</div>`;
          }
        } catch (error) {
          resultsDiv.innerHTML += `<div style="color:#e74c3c;">✗ GET request failed: ${error.message}</div>`;
        }
        
        // Then test with POST request
        try {
          resultsDiv.innerHTML += `<div>Testing POST request...</div>`;
          const postResponse = await fetch(CONFIG.googleSheetsApiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({test: 'connection'})
          });
          
          const postStatus = postResponse.status;
          resultsDiv.innerHTML += `<div>POST Status: ${postStatus}</div>`;
          
          try {
            const postData = await postResponse.json();
            resultsDiv.innerHTML += `<div style="color:#2ecc71;">✓ POST response parsed as JSON</div>`;
            resultsDiv.innerHTML += `<div style="max-height:100px;overflow:auto;background:#2c2c2c;padding:5px;margin:5px 0;border-radius:4px;">${JSON.stringify(postData, null, 2)}</div>`;
          } catch (e) {
            const postText = await postResponse.text();
            resultsDiv.innerHTML += `<div style="color:#e74c3c;">✗ POST response is not valid JSON</div>`;
            resultsDiv.innerHTML += `<div style="max-height:100px;overflow:auto;background:#2c2c2c;padding:5px;margin:5px 0;border-radius:4px;white-space:pre-wrap;font-size:10px;">${postText.substring(0, 500)}${postText.length > 500 ? '...' : ''}</div>`;
          }
        } catch (error) {
          resultsDiv.innerHTML += `<div style="color:#e74c3c;">✗ POST request failed: ${error.message}</div>`;
        }
        
        resultsDiv.innerHTML += `<div style="margin:5px 0;border-bottom:1px dashed #555;padding-bottom:5px;">URL being tested: ${CONFIG.googleSheetsApiUrl}</div>`;
      });
      
      document.getElementById('testCustom').addEventListener('click', async () => {
        const customUrl = document.getElementById('customEndpoint').value;
        if (!customUrl) {
          resultsDiv.innerHTML += `<div style="color:#e74c3c;">Please enter a URL to test</div>`;
          return;
        }
        
        resultsDiv.innerHTML += `<div style="margin:5px 0;border-bottom:1px dashed #555;padding-bottom:5px;">Testing custom URL: ${customUrl}</div>`;
        
        try {
          resultsDiv.innerHTML += `<div>Testing GET request...</div>`;
          const getResponse = await fetch(customUrl);
          const getStatus = getResponse.status;
          resultsDiv.innerHTML += `<div>GET Status: ${getStatus}</div>`;
          
          try {
            const getData = await getResponse.json();
            resultsDiv.innerHTML += `<div style="color:#2ecc71;">✓ GET response parsed as JSON</div>`;
            resultsDiv.innerHTML += `<div style="max-height:100px;overflow:auto;background:#2c2c2c;padding:5px;margin:5px 0;border-radius:4px;">${JSON.stringify(getData, null, 2)}</div>`;
          } catch (e) {
            const getText = await getResponse.text();
            resultsDiv.innerHTML += `<div style="color:#e74c3c;">✗ GET response is not valid JSON</div>`;
            resultsDiv.innerHTML += `<div style="max-height:100px;overflow:auto;background:#2c2c2c;padding:5px;margin:5px 0;border-radius:4px;white-space:pre-wrap;font-size:10px;">${getText.substring(0, 500)}${getText.length > 500 ? '...' : ''}</div>`;
          }
        } catch (error) {
          resultsDiv.innerHTML += `<div style="color:#e74c3c;">✗ GET request failed: ${error.message}</div>`;
        }
      });
    }

    /* -------------------------
       Add Diagnostics Button
       ------------------------- */
        function addAdminSection() {
          // Remove the original diagnostics button if it exists
          const existingButton = document.querySelector('button[innerHTML="Diagnostics"]');
          if (existingButton) {
            try {
              existingButton.parentNode.removeChild(existingButton);
            } catch (e) {
              console.warn("Could not remove existing diagnostics button:", e);
            }
          }

          // Create the admin button
          const adminButton = document.createElement('button');
          adminButton.innerHTML = '⚙️';
          adminButton.style.position = 'fixed';
          adminButton.style.bottom = '10px';
          adminButton.style.right = '10px';
          adminButton.style.zIndex = '1000';
          adminButton.style.backgroundColor = '#34495e';
          adminButton.style.color = 'white';
          adminButton.style.border = 'none';
          adminButton.style.borderRadius = '50%';
          adminButton.style.width = '40px';
          adminButton.style.height = '40px';
          adminButton.style.fontSize = '18px';
          adminButton.style.cursor = 'pointer';
          adminButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';

          let adminPanelVisible = false;

          adminButton.addEventListener('click', () => {
            if (adminPanelVisible) {
              hideAdminPanel();
            } else {
              showAdminPanel();
            }
          });

          document.body.appendChild(adminButton);

          // Create the admin panel (initially hidden)
          const adminPanel = document.createElement('div');
          adminPanel.id = 'adminPanel';
          adminPanel.style.position = 'fixed';
          adminPanel.style.bottom = '60px';
          adminPanel.style.right = '10px';
          adminPanel.style.backgroundColor = '#34495e';
          adminPanel.style.color = 'white';
          adminPanel.style.padding = '15px';
          adminPanel.style.borderRadius = '8px';
          adminPanel.style.width = '300px';
          adminPanel.style.boxShadow = '0 2px 10px rgba(0,0,0,0.5)';
          adminPanel.style.zIndex = '999';
          adminPanel.style.display = 'none';

          adminPanel.innerHTML = `
        <div style="text-align:center;margin-bottom:15px;font-weight:bold;color:#e74c3c;">
          ADMIN PANEL - RESTRICTED ACCESS
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <button id="diagnosticsBtn" style="background:#3498db;border:none;color:white;padding:8px;border-radius:4px;cursor:pointer;">
            Run Diagnostics
          </button>
          <button id="clearDataBtn" style="background:#e74c3c;border:none;color:white;padding:8px;border-radius:4px;cursor:pointer;">
            Clear All Data
          </button>
          <button id="exportDataBtn" style="background:#27ae60;border:none;color:white;padding:8px;border-radius:4px;cursor:pointer;">
            Export Data
          </button>
          <button id="closeAdminBtn" style="background:#7f8c8d;border:none;color:white;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">
            Close
          </button>
        </div>
      `;

          document.body.appendChild(adminPanel);

          // Function to show the admin panel
          function showAdminPanel() {
            adminPanel.style.display = 'block';
            adminPanelVisible = true;

            // Add event listeners to buttons
            document.getElementById('diagnosticsBtn').addEventListener('click', runDiagnostics);
            document.getElementById('clearDataBtn').addEventListener('click', confirmClearData);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('closeAdminBtn').addEventListener('click', hideAdminPanel);
          }

          // Function to hide the admin panel
          function hideAdminPanel() {
            adminPanel.style.display = 'none';
            adminPanelVisible = false;
          }

          // Function to confirm data clearing
          function confirmClearData() {
            const confirmed = confirm("WARNING: This will delete ALL data, including archived data. This cannot be undone. Are you sure?");
            if (confirmed) {
              localStorage.clear();
              alert("All data has been cleared. The page will now reload.");
              location.reload();
            }
          }

          // Function to export data
          function exportData() {
            try {
              const allData = {
                currentDate: new Date().toISOString(),
                todayKey: todayKey,
                medicationRecords: medicationRecords,
                weightRecord: weightRecord,
                bmRecord: bmRecord,
                drinkRecord: drinkRecord,
                mealsRecord: mealsRecord,
                sleepRecord: sleepRecord,
                activityRecord: activityRecord,
                mentalRecord: mentalRecord,
                physicalSymptoms: physicalSymptoms,
                notesRecord: notesRecord,
                archive: JSON.parse(localStorage.getItem('healthArchive') || '{}')
              };

              const dataStr = JSON.stringify(allData, null, 2);
              const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

              const exportFileDefaultName = 'health_data_export_' + new Date().toISOString().slice(0, 10) + '.json';

              const linkElement = document.createElement('a');
              linkElement.setAttribute('href', dataUri);
              linkElement.setAttribute('download', exportFileDefaultName);
              linkElement.click();
            } catch (error) {
              console.error("Error exporting data:", error);
              alert("Error exporting data: " + error.message);
            }
          }
        }

        // Replace the existing addDiagnosticsButton function with the new admin section
    function addDiagnosticsButton() {
      addAdminSection();
    }

        // At page initialization, set the connection status display correctly
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('dashboard').style.display = 'flex';
      
      // Set up the sync toggle button and update initial display
      document.getElementById('toggleSyncMode').addEventListener('click', toggleSyncMode);
      updateConnectionStatusDisplay();

      // Start with a connection test if Google Sheets is enabled
      if (!CONFIG.localModeOnly && CONFIG.enableGoogleSheets) {
        const statusBar = document.getElementById('connectionStatusBar');
        statusBar.style.background = '#3498db';
        statusBar.querySelector('span').innerHTML = '⏳ Testing Google Sheets Connection...';

        testGoogleSheetsConnection().then(result => {
          if (result.result === "error" || result.result === "local_only") {
            CONFIG.localModeOnly = true;
            updateConnectionStatusDisplay();
          } else {
            updateConnectionStatusDisplay();
          }
        });
      }
      
      // Rest of initialization
      if (checkChartJsLoaded()) {
        // Make sure all chart canvases are properly accessible
        setTimeout(() => {
          try {
            initCharts();
            console.log("Charts initialized successfully");
          } catch (e) {
            console.error("Error initializing charts:", e);
            // Try again with a delay in case DOM elements weren't fully rendered
            setTimeout(initCharts, 500);
          }
        }, 100);
      }
      
      generateMedTable();
      
      // Add admin section instead of simple diagnostics button
      addAdminSection();
      
      // Check for existing data
      const hasExistingData = 
        (localStorage.getItem('medicationRecords') && JSON.parse(localStorage.getItem('medicationRecords')).length > 0) ||
        localStorage.getItem('bmRecord') || 
        localStorage.getItem('drinkRecord') ||
        localStorage.getItem('mealsRecord');
      
      if (hasExistingData) {
        console.log("Found existing data in local storage");
      }
    });
  </script>
</body>
</html>